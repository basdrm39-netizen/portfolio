<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>マール画廊 PORTFOLIO (HTML Live)</title>
  <style>
    :root{ --ink:#0f172a; --muted:#475569; --line:#e2e8f0; --bg:#f8fafc; --chip:#f8fafc; }
    html,body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,'Segoe UI',Roboto,'Noto Sans JP',sans-serif}
    .wrap{max-width:1200px;margin:0 auto;padding:16px}
    header{position:sticky;top:0;background:rgba(255,255,255,0.9);backdrop-filter:saturate(180%) blur(6px);border-bottom:1px solid var(--line);z-index:10}
    h1{margin:0;font-size:28px;font-weight:800}
    .sub{font-size:12px;color:#64748b;margin-top:6px}
    .ctrl{display:grid;grid-template-columns:1fr 180px auto;gap:8px;margin-top:12px}
    .inp,.sel,.btn{padding:10px 12px;border:1px solid #cbd5e1;border-radius:10px;background:#fff}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:16px;margin-top:16px}
    .card{background:#fff;border:1px solid var(--line);border-radius:16px;overflow:hidden;box-shadow:0 1px 4px rgba(0,0,0,.04)}
    .ph{width:100%;aspect-ratio:3/4;background:linear-gradient(135deg,#e2e8f0,#cbd5e1);display:grid;place-items:center;color:#475569}
    .img{width:100%;aspect-ratio:3/4;object-fit:cover;display:block;cursor:zoom-in}
    .meta{padding:12px}
    .title{font-weight:700}
    .meta-sub{margin-top:2px;font-size:12px;color:var(--muted)}
    .desc{margin-top:8px;font-size:13px;color:var(--muted)}
    .chips{margin-top:6px}
    .chip{display:inline-block;padding:2px 8px;border:1px solid var(--line);border-radius:999px;font-size:12px;color:#334155;background:var(--chip);margin:6px 6px 0 0}
    footer{border-top:1px solid var(--line);background:#fff}
    .foot{padding:16px 0;font-size:13px;color:var(--muted)}
    /* Lightbox */
    .lb{position:fixed;inset:0;background:rgba(0,0,0,.8);display:none;place-items:center;z-index:50}
    .lb.show{display:grid}
    .lb img{max-width:90vw;max-height:82vh;border-radius:12px;box-shadow:0 8px 32px rgba(0,0,0,.4)}
    .bar{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);display:flex;gap:8px}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>マール画廊 PORTFOLIO <span style="font-size:12px;color:#64748b;margin-left:8px">HTML LIVE + LOCAL</span></h1>
      <div class="ctrl">
        <input id="q" class="inp" placeholder="検索（タイトル/タグ）" />
        <select id="tag" class="sel"><option value="all">タグ：すべて</option></select>
        <button id="reload" class="btn">手動リロード</button>
      </div>
      <div class="sub">データ元：<code id="src"></code>（約 <span id="sec"></span> 秒ごとに自動更新）<span id="err" style="color:#ef4444"></span></div>
    </div>
  </header>

  <main class="wrap" style="padding-bottom:96px">
    <div id="grid" class="grid"></div>
  </main>

  <div id="lb" class="lb">
    <figure id="lbFig"></figure>
    <div class="bar">
      <button class="btn" id="prev">← Prev</button>
      <button class="btn" id="next">Next →</button>
      <button class="btn" id="close">Close ✕</button>
    </div>
  </div>

  <footer>
    <div class="wrap foot">作品は過去作の参考展示です / 再販不可 / 本作品群に登場する人物は全て18歳以上です</div>
  </footer>

  <script>
  // ===== 設定 =====
  const WORKS_URL = 'https://raw.githubusercontent.com/basdrm39-netizen/portfolio/main/works.json';
  const POLL_MS = 10000;  // 10秒
  const LIVE_ON = true;   // リモートを使わないなら false

  // ===== ローカル作品（そのまま）=====
  const LOCAL_WORKS = [
    { id:'w1', title:'月下美人', tags:['鬼滅の刃','胡蝶しのぶ'], status:'available',
      img:'https://raw.githubusercontent.com/basdrm39-netizen/portfolio/main/test/n3g9-9-10.jpg', desc:'ヤフオク出品の過去作品', buyUrl:'' },
    { id:'w2', title:'悪魔凌辱', tags:['チェンソーマン','レゼ','R18','バック'], status:'sold',
      img:'https://raw.githubusercontent.com/basdrm39-netizen/portfolio/main/test/n3g9-15-05.jpg', desc:'ヤフオク出品の過去作品', buyUrl:'' },
    { id:'w3', title:'美声少女の種絞り', tags:['ボカロ','鏡音リン','R18','騎乗位'], status:'available',
      img:'https://raw.githubusercontent.com/basdrm39-netizen/portfolio/main/test/n3g9-10-19.jpg', desc:'リクエスト作品', buyUrl:'' },
    { id:'w4', title:'吸血鬼 妹', tags:['東方','フランドール・スカーレット'], status:'available',
      img:'https://raw.githubusercontent.com/basdrm39-netizen/portfolio/main/test/n3g9-10-06.jpg', desc:'ヤフオク出品の過去作品', buyUrl:'' },
    { id:'w5', title:'吸血鬼 姉', tags:['東方','レミリア・スカーレット'], status:'available',
      img:'https://raw.githubusercontent.com/basdrm39-netizen/portfolio/main/test/n3g9-10-02.jpg', desc:'ヤフオク出品の過去作品', buyUrl:'' },
    { id:'w6', title:'悪魔凌辱 天使', tags:['チェンソーマン','天使の悪魔','R18','バック'], status:'available',
      img:'https://raw.githubusercontent.com/basdrm39-netizen/portfolio/main/test/00039-2253065693.jpg', desc:'リクエスト作品', buyUrl:'' },
    { id:'w7', title:'美少女戦士の逆レイプ', tags:['セーラームーン','月野うさぎ','R18','おねショタ','ペニバン','逆レイプ'], status:'available',
      img:'https://raw.githubusercontent.com/basdrm39-netizen/portfolio/main/test/00002-708513414.jpg', desc:'リクエスト作品', buyUrl:'' },
    { id:'w8', title:'からかいの代償', tags:['からかい上手の高木さん','高木さん','R18','バック'], status:'available',
      img:'https://raw.githubusercontent.com/basdrm39-netizen/portfolio/main/test/n3g9-13-30.jpg', desc:'ヤフオク出品の過去作品', buyUrl:'' },
    { id:'w9', title:'美少女戦士の排泄攻め', tags:['セーラームーン','セーラーサターン','土萌ほたる','R18','おねショタ','スカトロ'], status:'available',
      img:'https://raw.githubusercontent.com/basdrm39-netizen/portfolio/main/test/00064-155387268.jpg', desc:'リクエスト作品', buyUrl:'' },
  ];

  // ===== 状態 =====
  let remoteWorks = [];
  let works = [];
  let filtered = [];
  let idx = -1;

  // 表示ラベル
  document.getElementById('src').textContent = WORKS_URL;
  document.getElementById('sec').textContent = POLL_MS/1000;

  // ===== リモート読込（キャッシュ回避＆404時空配列）=====
  async function loadRemote(showErr=true){
    if(!LIVE_ON){ remoteWorks=[]; mergeWorks(); render(); return; }
    try{
      const res = await fetch(WORKS_URL + '?t=' + Date.now(), { cache:'no-store' });
      if(!res.ok) throw new Error('HTTP ' + res.status);
      const json = await res.json();
      remoteWorks = Array.isArray(json) ? json : [];
      document.getElementById('err').textContent='';
    }catch(e){
      if(showErr) document.getElementById('err').textContent=' エラー：' + e.message;
      remoteWorks = []; // ←削除やエラー時は空に
    }finally{
      mergeWorks(); render();
    }
  }

  // ===== マージ（id/imgでユニーク化、リモート優先）=====
  function mergeWorks(){
    const merged = [...LOCAL_WORKS, ...remoteWorks];
    const map = new Map();
    for(const w of merged){
      const key = (w && (w.id || w.img)) || crypto.randomUUID();
      map.set(key, w); // 後勝ち＝リモート優先
    }
    works = [...map.values()];
    buildTagOptions();
  }

  // ===== フィルタ =====
  function getFiltered(){
    const q = document.getElementById('q').value.trim().toLowerCase();
    const tag = document.getElementById('tag').value;
    return works.filter(w=>{
      if(w.hidden===true || w.status==='hidden') return false;
      const okQ = !q || (w.title||'').toLowerCase().includes(q) || (w.tags||[]).join(' ').toLowerCase().includes(q);
      const okTag = (tag==='all') || (w.tags||[]).includes(tag);
      return okQ && okTag;
    });
  }

  // ===== 描画 =====
  function render(){
    filtered = getFiltered();
    const grid = document.getElementById('grid');
    grid.innerHTML = '';
    filtered.forEach((w,i)=>{
      const art = document.createElement('article');
      art.className = 'card';

      const imgWrap = document.createElement('div');
      if(w.img){
        const img = document.createElement('img');
        img.src = w.img; img.alt = w.title||''; img.loading='lazy'; img.className='img';
        img.onclick = ()=>openLb(i);
        imgWrap.appendChild(img);
      }else{
        const ph = document.createElement('div'); ph.className='ph'; ph.textContent='3:4 Placeholder';
        imgWrap.appendChild(ph);
      }

      const meta = document.createElement('div'); meta.className='meta';
      const h = document.createElement('div'); h.className='title'; h.textContent = w.title || 'Untitled';
      const sub = document.createElement('div'); sub.className='meta-sub';
      const bits = [w.collection, w.year, w.size].filter(Boolean);
      sub.textContent = bits.join(' ・ ');
      const desc = document.createElement('p'); desc.className='desc'; desc.textContent = w.desc || '';
      const chips = document.createElement('div'); chips.className='chips';
      (w.tags||[]).forEach(t=>{
        const s=document.createElement('span'); s.className='chip'; s.textContent=t; chips.appendChild(s);
      });

      meta.append(h, sub, desc, chips);
      art.append(imgWrap, meta);
      grid.appendChild(art);
    });
  }

  function buildTagOptions(){
    const all = new Set();
    works.forEach(w => (w.tags||[]).forEach(t => all.add(t)));
    const sel = document.getElementById('tag');
    const keep = sel.value;
    sel.innerHTML = '<option value="all">タグ：すべて</option>' + [...all].map(t=>`<option value="${t}">${t}</option>`).join('');
    if([...all,'all'].includes(keep)) sel.value = keep;
  }

  // ===== ライトボックス =====
  const lb = document.getElementById('lb');
  const lbFig = document.getElementById('lbFig');
  function openLb(i){ idx=i; lb.classList.add('show'); drawLb(); }
  function drawLb(){
    lbFig.innerHTML='';
    if(idx<0 || idx>=filtered.length) return;
    const img=document.createElement('img');
    img.src=filtered[idx].img; img.alt=filtered[idx].title||'';
    lbFig.appendChild(img);
  }
  function closeLb(){ idx=-1; lb.classList.remove('show'); }
  document.getElementById('close').onclick=closeLb;
  document.getElementById('prev').onclick=()=>{ idx=(idx-1+filtered.length)%filtered.length; drawLb(); };
  document.getElementById('next').onclick=()=>{ idx=(idx+1)%filtered.length; drawLb(); };
  lb.addEventListener('click',e=>{ if(e.target===lb) closeLb(); });
  window.addEventListener('keydown',e=>{
    if(!lb.classList.contains('show')) return;
    if(e.key==='Escape') closeLb();
    if(e.key==='ArrowLeft') document.getElementById('prev').click();
    if(e.key==='ArrowRight') document.getElementById('next').click();
  });

  // ===== イベント =====
  document.getElementById('q').addEventListener('input',render);
  document.getElementById('tag').addEventListener('change',render);
  document.getElementById('reload').addEventListener('click',()=>loadRemote(true));

  // ===== 起動 =====
  mergeWorks(); render();                 // まずローカル表示
  loadRemote(true);                       // リモート1回読み
  setInterval(()=>loadRemote(false), POLL_MS); // 定期更新
  </script>
</body>
</html>